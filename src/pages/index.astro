---
// src/pages/index.astro
import MainLayout from '../layouts/MainLayout.astro';
---

<style>
  /* Loading modal styles */
  .modal.show {
    display: block !important;
  }
  
  .modal-backdrop {
    background-color: rgba(0,0,0,0.8);
  }
  
  /* Smooth transitions */
  [x-cloak] {
    display: none !important;
  }
  
  /* Fade transitions */
  .fade-enter-active, .fade-leave-active {
    transition: opacity 0.3s ease;
  }
  .fade-enter, .fade-leave-to {
    opacity: 0;
  }
</style>

        <MainLayout title="Music Library">
          <div id="top"></div>
          <div x-data="library" x-init="init()" x-bind:class="{ 'debug-loaded': true }" x-cloak>
    
    <!-- Loading Modal -->
    <div x-show="allSongs.length === 0" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.8);" x-transition:enter="fade" x-transition:leave="fade" x-bind:style="allSongs.length > 0 ? 'display: none !important;' : ''">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-5">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mb-2">Loading Music Library</h5>
            <p class="text-muted mb-0">Please wait while we load your songs and album covers...</p>
            <div class="progress mt-3" style="height: 4px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content (disabled while loading) -->
    <div x-show="allSongs.length > 0" x-transition:enter="fade" x-transition:leave="fade">
      <!-- Library Stats -->
      <div class="text-center mb-3">
        Library: <span x-text="totalSongs || 0"></span> songs
        <span x-show="(searchTerm && searchTerm.trim()) || (filters.artist && filters.artist.trim()) || (filters.album && filters.album.trim()) || (filters.year && filters.year.toString().trim())" class="ms-2">
          | Showing <span x-text="displayedSongs.length || 0"></span> filtered results
        </span>
      </div>

    <!-- Search/Filter Bar: 4 cols on lg+, 2 cols on md, stacked on sm -->
    <div class="row g-3 mb-3">
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Search All</label>
        <input type="text" class="form-control" placeholder="Search songs, artists, albums..." x-model="searchTerm" @input="applyFiltersAndSort()" />
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Filter by Artist</label>
        <input type="text" class="form-control" placeholder="Enter artist name..." x-model="filters.artist" @input="applyFiltersAndSort()" />
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Filter by Album</label>
        <input type="text" class="form-control" placeholder="Enter album name..." x-model="filters.album" @input="applyFiltersAndSort()" />
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Filter by Year</label>
        <input type="number" class="form-control" placeholder="Enter year..." x-model="filters.year" @input="applyFiltersAndSort()" />
      </div>
    </div>

    <!-- Library Table -->
    <div class="table-responsive">
      <table class="table table-hover table-striped" style="table-layout: fixed; width: 100%;">
        <thead class="table-dark">
          <tr>
            <th @click="sort('title')" class="sortable" style="cursor: pointer; width: 25%;">
              Title 
              <span x-show="sortBy === 'title'">
                <i x-show="sortDir === 'asc'" class="fas fa-sort-up"></i>
                <i x-show="sortDir === 'desc'" class="fas fa-sort-down"></i>
              </span>
            </th>
            <th @click="sort('artist')" class="sortable" style="cursor: pointer; width: 20%;">
              Artist 
              <span x-show="sortBy === 'artist'">
                <i x-show="sortDir === 'asc'" class="fas fa-sort-up"></i>
                <i x-show="sortDir === 'desc'" class="fas fa-sort-down"></i>
              </span>
            </th>
            <th @click="sort('album')" class="sortable" style="cursor: pointer; width: 20%;">
              Album 
              <span x-show="sortBy === 'album'">
                <i x-show="sortDir === 'asc'" class="fas fa-sort-up"></i>
                <i x-show="sortDir === 'desc'" class="fas fa-sort-down"></i>
              </span>
            </th>
            <th @click="sort('duration')" class="sortable" style="cursor: pointer; width: 8%;">
              Duration 
              <span x-show="sortBy === 'duration'">
                <i x-show="sortDir === 'asc'" class="fas fa-sort-up"></i>
                <i x-show="sortDir === 'desc'" class="fas fa-sort-down"></i>
              </span>
            </th>
            <th @click="sort('year')" class="sortable" style="cursor: pointer; width: 7%;">
              Year 
              <span x-show="sortBy === 'year'">
                <i x-show="sortDir === 'asc'" class="fas fa-sort-up"></i>
                <i x-show="sortDir === 'desc'" class="fas fa-sort-down"></i>
              </span>
            </th>
            <th style="width: 10%;">Cover</th>
          </tr>
        </thead>
        <tbody>
          <!-- Loading state -->
          <tr x-show="allSongs.length === 0">
            <td colspan="6" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading your music library...</p>
            </td>
          </tr>
          
          <!-- Songs -->
          <template x-for="song in displayedSongs" :key="song.id">
            <tr @dblclick="playSong(song)" class="song-row">
              <td x-text="song.title"></td>
              <td x-text="song.artist"></td>
              <td x-text="song.album"></td>
              <td x-text="song.duration"></td>
              <td x-text="song.year"></td>
              <td>
                <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px;">
                  <img :src="song.cover" :alt="song.title + ' cover'" width="40" height="40" style="object-fit: cover; border-radius: 4px; max-width: 100%; max-height: 100%;" />
                </div>
              </td>
            </tr>
          </template>
          
          <!-- No songs state -->
          <tr x-show="allSongs.length > 0 && displayedSongs.length === 0">
            <td colspan="6" class="text-center py-4 text-muted">
              No songs found. Try adjusting your search or filters.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

                <!-- Lazy Loading Sentinel -->
                <div id="load-more-sentinel" class="text-center mb-5 pb-4" x-show="hasMoreSongs">
                  <div class="d-flex justify-content-center align-items-center" style="height: 60px;">
                    <div x-show="isLoadingMore" class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <div x-show="!isLoadingMore" class="text-muted">
                      <i class="fas fa-arrow-down"></i> Scroll to load more songs
                    </div>
                  </div>
                </div>

            <!-- Return to Top Button -->
            <a 
              href="#top"
              id="return-to-top-btn"
              x-show="showReturnToTop"
              class="btn btn-primary btn-lg position-fixed rounded-circle shadow-lg d-flex align-items-center justify-content-center"
              style="bottom: 120px; right: 20px; z-index: 1050; width: 60px; height: 60px; padding: 0; text-decoration: none;"
              title="Return to top"
            >
              <i class="fas fa-arrow-up"></i>
            </a>
    </div> <!-- End Main Content -->

              </div>
</MainLayout>